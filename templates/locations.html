{% extends "base.html" %}
{% block content %}
<h2>Locations</h2>

<!-- Add location form -->
<form method="POST" class="row g-3 mb-4" action="{{ url_for('locations') }}">
  <div class="col-md-4"><input name="location_id" class="form-control" placeholder="Location ID" required></div>
  <div class="col-md-6"><input name="name" class="form-control" placeholder="Name" required></div>
  <div class="col-md-2"><button name="add" value="1" class="btn btn-primary w-100">Add</button></div>
</form>

<table class="table table-bordered align-middle">
  <thead class="table-dark">
    <tr><th>ID</th><th>Name</th><th>Actions</th></tr>
  </thead>
  <tbody>
    {% for l in locations %}
    <tr>
      <td class="align-middle">{{ l.location_id }}</td>

      <td>
        <input id="loc-name-{{ l.location_id }}" type="text" class="form-control" value="{{ l.name }}">
      </td>

      <td class="text-nowrap">
        <button class="btn btn-sm btn-warning" onclick="updateLocation('{{ l.location_id }}')">Update</button>
        <a href="{{ url_for('delete_location', lid=l.location_id) }}" class="btn btn-sm btn-danger ms-2"
           onclick="return confirm('Delete location {{ l.location_id }}?')">Delete</a>

        <!-- Hidden fallback form -->
        <form id="fallback-lform-{{ l.location_id }}" action="{{ url_for('update_location') }}" method="POST" style="display:none;">
          <input type="hidden" name="location_id" value="{{ l.location_id }}">
          <input type="hidden" name="name" id="fallback-lname-{{ l.location_id }}">
          <button type="submit">Submit</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  async function updateLocation(lid) {
    const name = document.getElementById('loc-name-' + lid).value;
    try {
      const resp = await fetch("{{ url_for('update_location') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ location_id: lid, name: name })
      });
      if (resp.ok) {
        location.reload();
      } else {
        const data = await resp.json();
        alert('Update failed: ' + (data.error || 'server error'));
      }
    } catch (err) {
      // fallback
      document.getElementById('fallback-lname-' + lid).value = name;
      document.getElementById('fallback-lform-' + lid).submit();
    }
  }
</script>

{% endblock %}
